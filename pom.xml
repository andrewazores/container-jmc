<?xml version="1.0" encoding="UTF-8"?>
<project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

<modelVersion>4.0.0</modelVersion>
<groupId>com.redhat.rhjmc.containerjfr</groupId>
<artifactId>container-jfr</artifactId>
<version>0.16.0</version>
<packaging>jar</packaging>
<name>container-jfr</name>
<url>http://maven.apache.org</url>

<properties>
  <java.version>11</java.version>
  <maven.compiler.target>${java.version}</maven.compiler.target>
  <maven.compiler.source>${java.version}</maven.compiler.source>
  <imageBuilder>/usr/bin/podman</imageBuilder>
  <containerjfr.minimal>false</containerjfr.minimal>
  <containerjfr.imageStream>quay.io/rh-jmc-team/container-jfr</containerjfr.imageStream>
  <containerjfr.webPort>8181</containerjfr.webPort>
  <containerjfr.listenPort>9090</containerjfr.listenPort>
</properties>

<dependencies>
  <dependency>
    <groupId>com.redhat.rhjmc</groupId>
    <artifactId>containerjfr-core</artifactId>
    <version>0.9.0</version>
  </dependency>
  <dependency>
    <groupId>io.fabric8</groupId>
    <artifactId>openshift-client</artifactId>
    <version>4.6.4</version>
  </dependency>
  <dependency>
    <groupId>io.kubernetes</groupId>
    <artifactId>client-java</artifactId>
    <version>5.0.0</version>
  </dependency>
  <dependency>
    <groupId>com.google.dagger</groupId>
    <artifactId>dagger</artifactId>
    <version>2.26</version>
  </dependency>
  <dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.9</version>
  </dependency>
  <dependency>
    <groupId>commons-codec</groupId>
    <artifactId>commons-codec</artifactId>
    <version>1.13</version>
  </dependency>
  <dependency>
    <groupId>org.apache.httpcomponents</groupId>
    <artifactId>httpclient</artifactId>
    <version>4.5.11</version>
  </dependency>
  <dependency>
    <groupId>org.apache.httpcomponents</groupId>
    <artifactId>httpmime</artifactId>
    <version>4.5.11</version>
  </dependency>
  <dependency>
    <groupId>org.jsoup</groupId>
    <artifactId>jsoup</artifactId>
    <version>1.12.1</version>
  </dependency>
  <dependency>
    <groupId>io.vertx</groupId>
    <artifactId>vertx-web</artifactId>
    <version>3.8.5</version>
  </dependency>
  <dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
    <version>2.8.6</version>
  </dependency>
  <dependency>
    <groupId>com.github.spotbugs</groupId>
    <artifactId>spotbugs-annotations</artifactId>
    <version>4.0.0-RC1</version>
  </dependency>

  <!-- test deps -->
  <dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter-api</artifactId>
    <version>5.6.0</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter-params</artifactId>
    <version>5.6.0</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.hamcrest</groupId>
    <artifactId>hamcrest</artifactId>
    <version>2.2</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-junit-jupiter</artifactId>
    <version>3.2.4</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-inline</artifactId>
    <version>3.2.4</version>
    <scope>test</scope>
  </dependency>
</dependencies>

<build>
  <plugins>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-compiler-plugin</artifactId>
      <version>3.6.1</version>
      <configuration>
        <annotationProcessorPaths>
          <path>
            <groupId>com.google.dagger</groupId>
            <artifactId>dagger-compiler</artifactId>
            <version>2.26</version>
          </path>
        </annotationProcessorPaths>
      </configuration>
    </plugin>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-surefire-plugin</artifactId>
      <version>3.0.0-M4</version>
    </plugin>
    <plugin>
      <groupId>com.google.cloud.tools</groupId>
      <artifactId>jib-maven-plugin</artifactId>
      <version>2.1.0</version>
      <executions>
        <execution>
          <id>build-oci-image</id>
          <phase>package</phase>
          <goals>
            <goal>dockerBuild</goal>
          </goals>
        </execution>
      </executions>
      <configuration>
        <dockerClient>
          <executable>${imageBuilder}</executable>
        </dockerClient>
        <from>
          <image>gcr.io/distroless/java:11</image>
        </from>
        <to>
          <image>${containerjfr.imageStream}</image>
          <tags>${containerjfr.imageVersion}</tags>
        </to>
        <container>
          <creationTime>USE_CURRENT_TIMESTAMP</creationTime>
          <jvmFlags>-XX:+CrashOnOutOfMemoryError,-Dcom.sun.management.jmxremote.port=9091,-Dcom.sun.management.jmxremote.ssl=false,-Dcom.sun.management.jmxremote.authenticate=false</jvmFlags>
          <ports>${containerjfr.webPort},${containerjfr.listenPort},9091</ports>
        </container>
        <extraDirectories>
          <paths>
            <path>${project.build.directory}/assets</path>
          </paths>
        </extraDirectories>
      </configuration>
    </plugin>
  </plugins>
</build>

<profiles>
  <profile>
    <id>minimal</id>
    <activation>
      <property>
        <name>containerjfr.minimal</name>
        <value>true</value>
      </property>
    </activation>
    <properties>
      <containerjfr.imageVersion>${project.version}-minimal</containerjfr.imageVersion>
    </properties>
  </profile>
  <profile>
    <id>non-minimal</id>
    <activation>
      <property>
        <name>containerjfr.minimal</name>
        <value>!true</value>
      </property>
    </activation>
    <properties>
      <containerjfr.imageVersion>${project.version}</containerjfr.imageVersion>
    </properties>
    <build>
      <plugins>
        <plugin>
          <groupId>org.codehaus.mojo</groupId>
          <artifactId>exec-maven-plugin</artifactId>
          <version>1.6.0</version>
          <executions>
            <execution>
              <id>update-web-client-deps</id>
              <phase>compile</phase>
              <goals>
                <goal>exec</goal>
              </goals>
              <configuration>
                <executable>npm</executable>
                <workingDirectory>web-client</workingDirectory>
                <arguments>
                  <argument>ci</argument>
                </arguments>
              </configuration>
            </execution>
            <execution>
              <id>build-web-client</id>
              <phase>compile</phase>
              <goals>
                <goal>exec</goal>
              </goals>
              <configuration>
                <executable>npm</executable>
                <workingDirectory>web-client</workingDirectory>
                <arguments>
                  <argument>run</argument>
                  <argument>build</argument>
                </arguments>
              </configuration>
            </execution>
            <execution>
              <id>clean-web-client</id>
              <phase>clean</phase>
              <goals>
                <goal>exec</goal>
              </goals>
              <configuration>
                <executable>rm</executable>
                <workingDirectory>web-client</workingDirectory>
                <arguments>
                  <argument>-rf</argument>
                  <argument>node_modules</argument>
                  <argument>dist</argument>
                </arguments>
              </configuration>
            </execution>
          </executions>
        </plugin>
        <plugin>
          <artifactId>maven-resources-plugin</artifactId>
          <version>3.1.0</version>
          <executions>
            <execution>
              <id>copy-web-client-resources</id>
              <phase>compile</phase>
              <goals>
                <goal>copy-resources</goal>
              </goals>
              <configuration>
                <resources>
                  <resource>
                    <directory>web-client/dist/container-jfr-web</directory>
                  </resource>
                </resources>
                <outputDirectory>${project.build.directory}/assets/app/resources/com/redhat/rhjmc/containerjfr/net/web</outputDirectory>
              </configuration>
            </execution>
          </executions>
        </plugin>
      </plugins>
    </build>
  </profile>
</profiles>

</project>
